#!/bin/bash
# Populate my DB of TVs
SCRIPT_NAME="c.ln2tb-tv-find-popdb-helper"

# Source the VAR MOAS
source /usr/local/bin/VAR-SCRIPT

count="$(cat $count_file)"

DIR="$(echo $( dirname "$( echo $1 )") | rev |cut -d/ -f1 |rev)"
NAME="$(basename "$( echo $1 )")"
SUB="$( echo $1 | rev | cut -d"." -f2- | rev )"
NFO="$( echo $1 | rev | cut -d"." -f2- | rev )".nfo
[ -f "$NFO" ] && PLAY_COUNT="$(grep playcount "$NFO" | sed 's/<playcount>//;s/<\/playcount>//;s/ //g' | head -n1)" 2>/dev/null

SUBTITILE="NO"
if find "$SUB"*.srt -exec echo -n \; ; then SUBTITILE="YES" ; fi 2>/dev/null
if find "$SUB"*.sub -exec echo -n \; ; then SUBTITILE="YES" ; fi 2>/dev/null


if [ -f "$NFO" ]
then
	if [ ! -z "$PLAY_COUNT" ]
	then 
		if [ "$PLAY_COUNT" -gt "0" ] ; then WATCHED="YES" ; else WATCHED="NO" ; fi
	else
		WATCHED="(N/A): Incomplete NFO file"
	fi
else
	WATCHED="(N/A): No NFO file"
fi


mysql -uroot -p"$DB_PASSWORD" tv << EOF
INSERT INTO tv (Name,Size_MB,ResWidth,ResHeight,Watched,Notes,Definition,Date,Subtitle) 
VALUES ("$DIR/$NAME", "-", "-", "-", "$WATCHED", "-", "-", "-", "$SUBTITILE")
ON DUPLICATE KEY UPDATE 
	Name = "$DIR/$NAME",
	Watched = "$WATCHED",
	Subtitle = "$SUBTITILE";	
EOF

# To give colorized output
[ "$SUBTITILE"x = "YES"x ] && SUBTITLE="${GREEN}$SUBTITLE" || SUBTITLE="${RED}$SUBTITLE"
[ "$WATCHED"x = "YES"x   ] && WATCHED="${GREEN}$WATCHED"   || WATCHED="${RED}$WATCHED"

GREEN
echo -e "$count)${CYAN} Adding Episode: ${COLOR_OFF}$DIR/$NAME"
echo -ne "          ${PURPLE}Watched:${COLOR_OFF}[$WATCHED]  ${PURPLE}Sub:${COLOR_OFF}[$SUBTITILE]"
echo $((count + 1)) > "$count_file"
