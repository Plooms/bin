#!/bin/bash
# Populate my DB of TVs
SCRIPT_NAME="c.ln2tb-tv-find-popdb-helper"

# Source the VAR MOAS
source /usr/local/bin/VAR-SCRIPT


count="$(cat $count_file)"


DIR="$(echo $( dirname "$( echo $1 )") | rev |cut -d/ -f1 |rev)"
NAME="$(basename "$( echo $1 )")"
SUB="$( echo $1 | rev |cut -b 5- | rev )"
NFO="$( echo $1 | rev |cut -b 5- | rev )".nfo
[ -f "$NFO" ] && PLAY_COUNT="$(grep playcount "$NFO" | sed 's/<playcount>//;s/<\/playcount>//;s/ //g')" 2>/dev/null


SUBTITILE="NO"
if find "$SUB"*.srt -exec echo -n \; ; then SUBTITILE="YES" ; fi 2>/dev/null
if find "$SUB"*.sub -exec echo -n \; ; then SUBTITILE="YES" ; fi 2>/dev/null


mysql -uroot -p"$DB_PASSWORD" tv << EOF
INSERT INTO tv (Name,Size_MB,ResWidth,ResHeight,Watched,Notes,Definition,Date,Subtitle) 
VALUES ("$DIR/$NAME", "-", "-", "-", "$WATCHED", "-", "-", "-", "$SUBTITILE")
ON DUPLICATE KEY UPDATE 
	Name = "$DIR/$NAME",
	Watched = "$WATCHED",
	Subtitle = "$SUBTITILE";	
EOF

GREEN
echo -ne "$count)${CYAN} Adding Episode: ${COLOR_OFF}$DIR/$NAME"
echo $((count + 1)) > "$count_file"
