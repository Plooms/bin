#!/bin/bash
# Wrapper for vlc that checks for xspf files
SCRIPT_NAME="vlc-alternate-player"
PID=$$


# Source the VAR MOAS
source /usr/local/bin/VAR-SCRIPT




#########################################################
FNAME="$1"


TMP="$(mktemp)"
TIME_TMP="$(mktemp)"
TRIGGER1="$(mktemp)"
TRIGGER2="$(mktemp)"

# To get the filename without extensions
FILENAME="$( echo "$FNAME" | rev | cut -d"."  -f2- | rev )"
# To get the filename without the path
FILENAME2="$( echo "$FNAME" | rev | cut -d"/" -f1  | rev )"
# To get the path without the filename
FILENAME3="$( dirname "$FNAME" )"


touch $TRIGGER1
while [ -f $TRIGGER1 ] ; do sleep .1 && [ -f $TRIGGER2 ] && curl -s -u ":vlcremote" http://127.0.0.1:8888/requests/status.json | grep time | sed 's/,//g' |cut -b 10- ; done > $TIME_TMP &


if [ -f "$FILENAME"*.xspf ]

then 

	if 
	
		# Find if we need Subs Really
		[ "$(cat "$FILENAME3"/1-info 2>/dev/null)" = "No Need For Subs" ]
	
	then
		echo "No Need For Subs"
	
	else

		[ -f "$(ls "$FILENAME"*.srt 2>/dev/null |head -n1)" -o -f "$(ls "$FILENAME"*.sub 2>/dev/null |head -n1)" ] || terminator -x filebot -get-missing-subtitles --lang en -non-strict "$FNAME"
		[ -f "$(ls "$FILENAME"*.srt 2>/dev/null |head -n1)" -o -f "$(ls "$FILENAME"*.sub 2>/dev/null |head -n1)" ] || (notify-send "Media" "Subtitle Not Found"  &&  sudo beep)

	fi

	

	echo "" >> "$PLAYER_LAST_WATCHED"/"$DAY0".txt
	echo "$(date | cut -d" " -f 1-5) <-> Started  - ($FILENAME2)" >> "$PLAYER_LAST_WATCHED"/"$DAY0".txt

	# REPEAT variable comes from the repeater script to prevent clogging this file needlessly
	[ -z "$REPEAT" ] && echo "$FNAME" >> "$PLAYER_LAST_WATCHED"/"Last-Video".txt


	START_TIME=$(date +%s)

	
	if [ -f "$FNAME".time.txt ]
	then 
	touch $TRIGGER2
	vlc --quiet "$FNAME" --start-time "$(sed '/^$/d;/^ $/d;/^0$/d' "$FNAME".time.txt | tail -n1)" --play-and-exit --extraintf=http --http-host 127.0.0.1 --http-port 8888 --http-password 'vlcremote' 2>&1 >/dev/null
	rm $TRIGGER1 $TRIGGER2
	tail -n2 $TIME_TMP | sed '/^$/d;/^ $/d;/^0$/d' >  "$FNAME".time.txt

	else
	touch $TRIGGER2
	vlc --quiet "$FILENAME"*.xspf --play-and-exit --extraintf=http --http-host 127.0.0.1 --http-port 8888 --http-password 'vlcremote' 2>&1 >/dev/null
	rm $TRIGGER1 $TRIGGER2
	tail -n2 $TIME_TMP | sed '/^$/d;/^ $/d;/^0$/d' >  "$FNAME".time.txt

	fi


	KODI_LAST_WATCHED="$(ls -t ~/.kodi/userdata/Database/MyVideo* |head -n 1)" && sqlite3  "$KODI_LAST_WATCHED" "select strFilename, playCount from files where strFilename like '%$FILENAME2' ;" | head -n1  | sed 's/^|1//g;/|$/d;s/^[ \t]*//;s/[ \t]*$//;/^$/d' | cut -d"|" -f1 >> $TMP


else 
	
		if 
	
		# Find if we need Subs Really
		[ "$(cat "$FILENAME3"/1-info 2>/dev/null)" = "No Need For Subs" ]
	
		then
		echo "No Need For Subs"
	
		else

		[ -f "$(ls "$FILENAME"*.srt 2>/dev/null |head -n1)" -o -f "$(ls "$FILENAME"*.sub 2>/dev/null |head -n1)" ] || terminator -x filebot -get-missing-subtitles --lang en -non-strict "$FNAME"
		[ -f "$(ls "$FILENAME"*.srt 2>/dev/null |head -n1)" -o -f "$(ls "$FILENAME"*.sub 2>/dev/null |head -n1)" ] || (notify-send "Media" "Subtitle Not Found"  &&  sudo beep)

		fi


	echo "" >> "$PLAYER_LAST_WATCHED"/"$DAY0".txt
	echo "$(date | cut -d" " -f 1-5) <-> Started  - ($FILENAME2)" >> "$PLAYER_LAST_WATCHED"/"$DAY0".txt

	# REPEAT variable comes from the repeater script to prevent clogging this file needlessly
	[ -z "$REPEAT" ] && echo "$FNAME" >> "$PLAYER_LAST_WATCHED"/"Last-Video".txt



	START_TIME=$(date +%s)


	if [ -f "$FNAME".time.txt ]
	then 
	touch $TRIGGER2
	vlc --quiet "$FNAME" --start-time "$(sed '/^$/d;/^ $/d;/^0$/d' "$FNAME".time.txt | tail -n1)" --play-and-exit --extraintf=http --http-host 127.0.0.1 --http-port 8888 --http-password 'vlcremote' 2>&1 >/dev/null
	rm $TRIGGER1 $TRIGGER2
	tail -n2 $TIME_TMP | sed '/^$/d;/^ $/d;/^0$/d' >  "$FNAME".time.txt

	else 
	touch $TRIGGER2
	vlc --quiet "$FNAME" --play-and-exit --extraintf=http --http-host 127.0.0.1 --http-port 8888 --http-password 'vlcremote' 2>&1 >/dev/null
	rm $TRIGGER1 $TRIGGER2
	tail -n2 $TIME_TMP | sed '/^$/d;/^ $/d;/^0$/d' >  "$FNAME".time.txt

	fi
	
	KODI_LAST_WATCHED="$(ls -t ~/.kodi/userdata/Database/MyVideo* |head -n 1)" && sqlite3  "$KODI_LAST_WATCHED" "select strFilename, playCount from files where strFilename like '%$FILENAME2' ;" | head -n1  | sed 's/^|1//g;/|$/d;s/^[ \t]*//;s/[ \t]*$//;/^$/d' | cut -d"|" -f1 >> $TMP

fi



END_TIME=$(date +%s)
END_TIME_SEC=$(( END_TIME - START_TIME ))

[ "$END_TIME_SEC" -gt 60 ] &&  echo "$(date | cut -d" " -f 1-5) <-> Finished - ($FILENAME2)" >> "$PLAYER_LAST_WATCHED"/"$DAY0".txt

nohup sleep 1  2>&1 >/dev/null && while read a ; do notify-send "Media" "$a \n\nMarked as Watched" ; done < $TMP &

